{% extends "base.html" %}

{% block title %}Simulator{% endblock %}

{% block head_extras %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/allocate.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block content %}
<div class="container">
  <!-- Rebalancer Section -->
  <h2 class="section-title">Rebalancer</h2>

  <!-- Tab Navigation for Rebalancer -->
  <div class="header-content">
    <div class="tabs">
      <ul class="nav-tabs" id="allocationTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="global-tab" type="button" role="tab">
            <i class="fas fa-globe mr-2"></i>Global Overview
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="detailed-tab" type="button" role="tab">
            <i class="fas fa-chart-pie mr-2"></i>Detailed Overview
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" id="allocationTabsContent" style="display: block;">
    <!-- Global Overview Tab -->
    <div class="tab-pane active" id="global" role="tabpanel" style="display: block;">
      <!-- Rebalancing Mode -->
      <div class="rebalancing-controls">
        <div class="control">
          <label class="radio">
            <input type="radio" name="rebalance-mode" value="existing-only" checked>
            Rebalance Existing Capital
          </label>
          <label class="radio">
            <input type="radio" name="rebalance-mode" value="new-only">
            New Capital only (no sales)
          </label>
          <label class="radio">
            <input type="radio" name="rebalance-mode" value="new-with-sells">
            New Capital (with sales)
          </label>
        </div>
        <div class="investment-input" id="investment-input-container">
          <label class="label">Investment Amount:</label>
          <div class="input-group">
            <span class="input-group-text">â‚¬</span>
            <input type="text" class="input sensitive-value" id="investment-amount" placeholder="Enter amount">
          </div>
        </div>
      </div>

      <!-- Portfolio Table -->
      <div class="card">
        <div id="portfolio-table-container">
          <div class="has-text-centered">
            <div class="spinner-border" role="status">
              <span class="is-sr-only">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Legacy Country/Sector Charts (hidden, kept for backward compatibility) -->
      <div id="legacy-charts" style="display: none;">
        <div id="country-capacity-chart"></div>
        <div id="sector-capacity-chart"></div>
      </div>
    </div>

    <!-- Detailed Overview Tab -->
    <div class="tab-pane" id="detailed" role="tabpanel">
      <!-- Portfolio Selection Dropdown -->
      <div class="card">
        <div class="portfolio-select">
          <label class="label">Select Portfolio:</label>
          <div class="select is-fullwidth">
            <select class="form-select" id="portfolio-select">
              <option value="">Select a portfolio</option>
            </select>
          </div>
        </div>

        <!-- Expand/Collapse buttons -->
        <div class="mb-3">
          <button type="button" class="btn btn-outline-primary btn-sm me-2" id="expand-all-btn">
            <i class="fas fa-expand-arrows-alt me-1"></i>Expand All
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="collapse-all-btn">
            <i class="fas fa-compress-arrows-alt me-1"></i>Collapse All
          </button>
        </div>

        <!-- Single portfolio table will be rendered here -->
        <div id="detailed-portfolio-container">
          <div class="has-text-centered">
            <div class="spinner-border" role="status">
              <span class="is-sr-only">Loading...</span>
            </div>
          </div>
        </div>
        <div id="detailedChart" class="mt-4"></div>
      </div>
    </div>
  </div>

  <!-- Simulator Section -->
  <div class="section-header-collapsible">
    <h2 class="section-title" style="margin-bottom: 0;">
      Simulator
    </h2>
  </div>
  <div class="card" id="allocation-simulator-card" style="padding: var(--space-md);">
    <!-- Simulator Header with Load/Save -->
    <div class="simulator-header-bar">
      <div class="simulator-header-left">
        <div class="simulator-load-section">
          <div class="select-wrapper">
            <select class="form-select simulator-load-select" id="simulator-load-select">
              <option value="">New Simulation</option>
            </select>
          </div>
          <button class="btn btn-sm btn-outline-danger" id="simulator-delete-btn" style="display: none;" title="Delete simulation">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      <div class="simulator-header-right">
        <!-- Save button - only visible when editing existing simulation -->
        <button class="btn btn-sm simulator-btn-primary" id="simulator-save-btn" style="display: none;" title="Save changes to current simulation">
          <i class="fas fa-save"></i> Save
        </button>
        <!-- Save As button - always visible -->
        <button class="btn btn-sm simulator-btn-primary" id="simulator-saveas-btn" title="Save as new simulation">
          <i class="fas fa-copy"></i> Save As...
        </button>
      </div>
    </div>

    <!-- Scope Toggle -->
    <div class="simulator-scope-toggle">
      <div class="scope-label">Portfolio Scope:</div>
      <div class="scope-options">
        <label class="scope-option">
          <input type="radio" name="simulator-scope" value="global" checked>
          <span class="scope-option-text"><i class="fas fa-globe"></i> Global</span>
        </label>
        <label class="scope-option">
          <input type="radio" name="simulator-scope" value="portfolio">
          <span class="scope-option-text"><i class="fas fa-folder"></i> Portfolio</span>
        </label>
      </div>
      <div class="scope-portfolio-select" id="simulator-portfolio-select-wrapper" style="display: none;">
        <select class="form-select" id="simulator-portfolio-select">
          <option value="">Select portfolio...</option>
        </select>
      </div>
    </div>

    <div id="allocation-simulator-content">
      <!-- Simulator will be rendered here by JS -->
      <div id="allocation-simulator-container">
        <div class="has-text-centered">
          <div class="spinner-border" role="status">
            <span class="is-sr-only">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Simulation Modal -->
  <div class="modal-overlay" id="save-simulation-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Save Simulation</h3>
        <button class="modal-close" id="save-simulation-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="label" for="simulation-name-input">Simulation Name</label>
          <input type="text" class="input" id="simulation-name-input" placeholder="e.g., Tech Heavy Scenario" maxlength="100">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="save-simulation-cancel">Cancel</button>
        <button class="btn btn-primary" id="save-simulation-confirm">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/allocate.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/simulator.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script>
  // Initialize Allocation Simulator on page load
  (function() {
    function initSimulator() {
      new AllocationSimulator('allocation-simulator-container');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSimulator);
    } else {
      initSimulator();
    }
  })();
</script>
{% endblock %}