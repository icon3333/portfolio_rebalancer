{% extends "base.html" %}

{% block title %}Portfolio Allocation{% endblock %}

{% block head_extras %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/allocate.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block content %}
<div class="container">
  <h1 class="page-title">Portfolio Allocation</h1>

  <!-- Tab Navigation -->
  <div class="header-content">
    <div class="tabs">
      <ul class="nav-tabs" id="allocationTabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="global-tab" type="button" role="tab">
            <i class="fas fa-globe mr-2"></i>Global Overview
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="detailed-tab" type="button" role="tab">
            <i class="fas fa-chart-pie mr-2"></i>Detailed Overview
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Tab Content -->
  <!-- Note: inline style overrides ocean-depth.css .tab-content { display: none } -->
  <div class="tab-content" id="allocationTabsContent" style="display: block;">
    <!-- Global Overview Tab -->
    <!-- Note: inline style ensures visibility even if JS fails to load -->
    <div class="tab-pane active" id="global" role="tabpanel" style="display: block;">
      <h2 class="section-title">Investment Settings</h2>
      <!-- Investment Input in Global Overview -->
      <div class="card">
        <div class="field">
          <label class="label">Rebalancing Mode</label>
          <div class="control">
            <label class="radio">
              <input type="radio" name="rebalance-mode" value="existing-only" checked>
              Rebalance Existing Capital
            </label>
            <label class="radio">
              <input type="radio" name="rebalance-mode" value="new-only">
              New Capital only (no sales)
            </label>
            <label class="radio">
              <input type="radio" name="rebalance-mode" value="new-with-sells">
              New Capital (with sales)
            </label>
          </div>
        </div>
        <div class="investment-input" id="investment-input-container">
          <label class="label">Investment Amount:</label>
          <div class="input-group">
            <span class="input-group-text">€</span>
            <input type="text" class="input" id="investment-amount" placeholder="Enter amount">
          </div>
        </div>
      </div>

      <h2 class="section-title">Portfolio Allocations</h2>
      <div class="card">
        <div id="portfolio-table-container">
          <!-- Table will be rendered here -->
          <div class="has-text-centered">
            <div class="spinner-border" role="status">
              <span class="is-sr-only">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Allocation Simulator -->
      <div class="card mt-4" id="allocation-simulator-card">
        <div class="card-header" style="cursor: pointer;" onclick="toggleAllocationSimulator()">
          <h3 class="card-header-title">
            <i class="fas fa-sliders-h mr-2"></i>
            Allocation Simulator
          </h3>
          <button class="card-header-icon" aria-label="expand">
            <span class="icon">
              <i class="fas fa-angle-down" id="allocation-simulator-arrow"></i>
            </span>
          </button>
        </div>
        <div class="card-content" id="allocation-simulator-content" style="display: none;">
          <div class="content">
            <!-- Simulator Header -->
            <div class="simulator-header">
              <div class="simulator-header-left">
                <span class="available-to-invest-label">Available to Invest:</span>
                <span class="available-to-invest-value" id="available-to-invest-display">€0</span>
              </div>
              <div class="simulator-header-right">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="reset-simulator-btn">
                  <i class="fas fa-undo me-1"></i>Reset
                </button>
              </div>
            </div>

            <!-- Two-Column Slider Layout -->
            <div class="simulator-panels">
              <!-- Left Panel: Country Sliders (Primary) -->
              <div class="simulator-panel simulator-panel-primary" id="country-panel">
                <div class="panel-header">
                  <h4 class="panel-title">
                    <i class="fas fa-globe me-1"></i>Allocate by Country
                  </h4>
                  <span class="panel-subtitle">(drag sliders to allocate)</span>
                </div>
                <div class="slider-list" id="country-sliders">
                  <!-- Country sliders will be rendered here by JS -->
                  <div class="has-text-centered">
                    <div class="spinner-border" role="status">
                      <span class="is-sr-only">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="panel-footer">
                  <span class="panel-total-label">Total Allocated:</span>
                  <span class="panel-total-value" id="country-total-display">€0 / €0</span>
                </div>
              </div>

              <!-- Right Panel: Category Allocation -->
              <div class="simulator-panel simulator-panel-primary" id="category-panel">
                <div class="panel-header">
                  <h4 class="panel-title">
                    <i class="fas fa-tags me-1"></i>Allocate by Category
                  </h4>
                  <span class="panel-subtitle">(drag sliders to allocate)</span>
                </div>
                <div class="slider-list" id="category-sliders">
                  <!-- Category bars will be rendered here by JS -->
                  <div class="has-text-centered">
                    <div class="spinner-border" role="status">
                      <span class="is-sr-only">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="panel-footer">
                  <span class="panel-total-label">Total:</span>
                  <span class="panel-total-value" id="category-total-display">€0 / €0</span>
                </div>
              </div>
            </div>

            <!-- Allocation Matrix -->
            <div class="allocation-matrix-card" id="allocation-matrix-card">
              <div class="matrix-header" style="cursor: pointer;" onclick="toggleAllocationMatrix()">
                <h4 class="matrix-title">
                  <i class="fas fa-th me-1"></i>Allocation Matrix
                </h4>
                <span class="matrix-subtitle">Where your money flows</span>
                <button class="matrix-toggle-icon" aria-label="expand">
                  <i class="fas fa-angle-down" id="allocation-matrix-arrow"></i>
                </button>
              </div>
              <div class="matrix-content" id="allocation-matrix-content" style="display: none;">
                <div id="allocation-matrix">
                  <!-- Matrix will be rendered here by JS -->
                  <div class="has-text-centered">
                    <div class="spinner-border" role="status">
                      <span class="is-sr-only">Loading...</span>
                    </div>
                  </div>
                </div>
                <div class="matrix-footer">
                  <i class="fas fa-info-circle me-1"></i>
                  Hover over cells to see positions at each intersection
                </div>
              </div>
            </div>

            <!-- Constraint Warnings -->
            <div class="constraint-warnings" id="constraint-warnings" style="display: none;">
              <div class="warnings-header">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Constraint Warnings</span>
              </div>
              <div class="warnings-content" id="warnings-content">
                <!-- Warnings will be rendered here by JS -->
              </div>
              <div class="warnings-footer">
                These allocations violate your rules. Adjust sliders or update your limits in Allocation Builder.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Legacy Country/Category Charts (hidden, kept for backward compatibility) -->
      <div id="legacy-charts" style="display: none;">
        <div id="country-capacity-chart"></div>
        <div id="category-capacity-chart"></div>
      </div>
    </div>

    <!-- Detailed Overview Tab -->
    <div class="tab-pane" id="detailed" role="tabpanel">
      <h2 class="section-title">Portfolio Details</h2>
      <!-- Portfolio Selection Dropdown -->
      <div class="card">
        <div class="portfolio-select">
          <label class="label">Select Portfolio:</label>
          <div class="select is-fullwidth">
            <select class="form-select" id="portfolio-select">
              <!-- Options will be populated dynamically -->
              <option value="">Select a portfolio</option>
            </select>
          </div>
        </div>

        <!-- Expand/Collapse buttons -->
        <div class="mb-3">
          <button type="button" class="btn btn-outline-primary btn-sm me-2" id="expand-all-btn">
            <i class="fas fa-expand-arrows-alt me-1"></i>Expand All
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="collapse-all-btn">
            <i class="fas fa-compress-arrows-alt me-1"></i>Collapse All
          </button>
        </div>

        <!-- Single portfolio table will be rendered here -->
        <div id="detailed-portfolio-container">
          <div class="has-text-centered">
            <div class="spinner-border" role="status">
              <span class="is-sr-only">Loading...</span>
            </div>
          </div>
        </div>
        <div id="detailedChart" class="mt-4"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/allocate.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}