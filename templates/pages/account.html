{% extends "base.html" %}

{% block title %}Account Management - Portfolio Rebalancer{% endblock %}

{% block head_extras %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/account.css') }}">
{% endblock %}

{% block content %}
<div class="container account-page">
    <h2 class="section-title">Account Information</h2>

    <div class="account-grid">
        <!-- Left Panel: Account Details (read-only) -->
        <aside class="info-card">
            <h3 class="info-card-title">
                <i class="fas fa-id-card"></i>
                Account Details
            </h3>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input class="form-control" type="text" value="{{ account.username }}" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">Account ID</label>
                <input class="form-control" type="text" value="{{ account.id }}" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">Created At</label>
                <input class="form-control" type="text" value="{{ account.created_at }}" disabled>
            </div>
            <div class="form-group mb-0">
                <label class="form-label">Last Price Update</label>
                <input class="form-control" type="text" value="{{ account.last_price_update or 'Never' }}" disabled>
            </div>
        </aside>

        <!-- Right Panel: Actions -->
        <main>
            <!-- Tab Navigation -->
            <div class="account-tabs" id="accountTabs">
                <button class="nav-link active" id="settings-tab" type="button">Settings</button>
                <button class="nav-link" id="delete-tab" type="button">Delete</button>
            </div>

            <!-- Tab Content Container -->
            <div class="tab-content-wrapper">
                <!-- Settings Tab -->
                <div class="tab-pane active" id="settings" role="tabpanel">
                    <!-- Update Username Section -->
                    <div class="action-section is-info">
                        <div class="action-header">
                            <h3 class="action-title">
                                <i class="fas fa-edit" style="color: var(--primary);"></i>
                                Update Username
                            </h3>
                        </div>
                        <div class="action-body">
                            <form action="{{ url_for('account.update_account') }}" method="post">
                                <div class="form-group">
                                    <label class="form-label">New Username</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-user"></i>
                                        </span>
                                        <input class="form-control" type="text" name="new_username" placeholder="Enter new username" required>
                                    </div>
                                    <div class="form-text">Choose a unique username for your account</div>
                                </div>
                                <button type="submit" class="button is-primary">
                                    <i class="fas fa-save me-2"></i>
                                    Update Username
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Data Migration Section -->
                    <div class="action-section is-info">
                        <div class="action-header">
                            <h3 class="action-title">
                                <i class="fas fa-exchange-alt" style="color: var(--primary);"></i>
                                Data Migration
                            </h3>
                        </div>
                        <div class="action-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <div class="alert-content">
                                    <p><strong>Export:</strong> Download all your account data as a JSON file for backup or migration.</p>
                                    <p><strong>Import:</strong> Upload a JSON file to replace all current account data. This will permanently overwrite your existing data.</p>
                                </div>
                            </div>
                            <div class="button-grid">
                                <a href="{{ url_for('account.export_data') }}" class="button is-primary">
                                    <i class="fas fa-download me-2"></i>
                                    Export Account Data
                                </a>
                                <button type="button" class="button is-primary" onclick="openImportModal()">
                                    <i class="fas fa-upload me-2"></i>
                                    Import Account Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Tab -->
                <div class="tab-pane" id="delete" role="tabpanel" style="display: none;">
                    <!-- Delete Stock/Crypto Section -->
                    <div class="action-section is-warning">
                        <div class="action-header">
                            <h3 class="action-title">
                                <i class="fas fa-trash" style="color: var(--warning);"></i>
                                Delete Stock/Crypto
                            </h3>
                        </div>
                        <div class="action-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div class="alert-content">
                                    <p><strong>Warning:</strong> This will remove all stock and crypto data for your current account, including companies, shares, and market prices. This action cannot be undone.</p>
                                </div>
                            </div>
                            <form action="{{ url_for('account.delete_stocks_crypto') }}" method="post" id="delete-stocks-form">
                                <button type="submit" class="button is-warning">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Delete All Stocks & Crypto
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Reset Settings Section -->
                    <div class="action-section is-info">
                        <div class="action-header">
                            <h3 class="action-title">
                                <i class="fas fa-undo" style="color: var(--primary);"></i>
                                Reset Account Settings
                            </h3>
                        </div>
                        <div class="action-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <div class="alert-content">
                                    <p><strong>Info:</strong> This will clear all saved settings for this account and restore defaults.</p>
                                </div>
                            </div>
                            <form action="{{ url_for('account.reset_account_settings') }}" method="post" id="reset-account-form">
                                <button type="submit" class="button">
                                    <i class="fas fa-undo me-2"></i>
                                    Reset Account Settings
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Delete Account Section -->
                    <div class="action-section is-danger">
                        <div class="action-header">
                            <h3 class="action-title">
                                <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                                Delete Account
                            </h3>
                        </div>
                        <div class="action-body">
                            <div class="alert alert-danger">
                                <i class="fas fa-skull-crossbones"></i>
                                <div class="alert-content">
                                    <p><strong>Warning:</strong> Deleting your account is permanent and cannot be undone. All your portfolio data, preferences, and history will be permanently removed.</p>
                                </div>
                            </div>
                            <form action="{{ url_for('account.delete_account') }}" method="post" id="delete-account-form">
                                <div class="form-group">
                                    <label class="form-label">Confirmation</label>
                                    <input class="form-control" type="text" name="confirmation" placeholder="Type DELETE to confirm" required>
                                    <div class="form-text">Type <strong>DELETE</strong> in uppercase to confirm account deletion</div>
                                </div>
                                <button type="submit" class="button is-danger" id="delete-button" disabled>
                                    <i class="fas fa-trash-alt me-2"></i>
                                    Delete My Account
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Import Data Modal -->
<div class="modal fade account-page" id="import-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i>
                    Import Account Data
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="alert-content">
                        <p><strong>Warning:</strong> This action will permanently delete all data in your current account and replace it with the imported data.</p>
                        <p>This includes:</p>
                        <ul>
                            <li>All portfolios and companies</li>
                            <li>All share quantities and overrides</li>
                            <li>All saved settings and preferences</li>
                            <li>All identifier mappings</li>
                        </ul>
                        <p class="mb-0"><strong>This action cannot be undone!</strong> A backup will be created automatically before import.</p>
                    </div>
                </div>

                <form id="import-form" action="{{ url_for('account.import_data') }}" method="post" enctype="multipart/form-data">
                    <div class="form-group mb-0">
                        <label class="form-label">Select JSON Export File</label>
                        <input class="form-control" type="file" name="import_file" accept=".json" required>
                        <div class="form-text">Only JSON files exported from this application are supported</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="button" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="button is-danger" onclick="confirmImport()">
                    <i class="fas fa-upload me-2"></i>
                    Import Data (Overwrite Everything)
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Tab switching
        const settingsTab = document.getElementById('settings-tab');
        const deleteTab = document.getElementById('delete-tab');
        const settingsPane = document.getElementById('settings');
        const deletePane = document.getElementById('delete');

        settingsTab.addEventListener('click', () => {
            settingsTab.classList.add('active');
            deleteTab.classList.remove('active');
            settingsPane.style.display = 'block';
            deletePane.style.display = 'none';
        });

        deleteTab.addEventListener('click', () => {
            deleteTab.classList.add('active');
            settingsTab.classList.remove('active');
            deletePane.style.display = 'block';
            settingsPane.style.display = 'none';
        });

        // Delete account confirmation validator
        const confirmInput = document.querySelector('input[name="confirmation"]');
        const deleteButton = document.getElementById('delete-button');

        if (confirmInput && deleteButton) {
            confirmInput.addEventListener('input', function () {
                deleteButton.disabled = this.value !== 'DELETE';
            });
        }

        // Delete account form submission confirmation
        const deleteForm = document.getElementById('delete-account-form');
        if (deleteForm) {
            deleteForm.addEventListener('submit', function (e) {
                if (!confirm('Are you sure you want to permanently delete this account? This action cannot be undone.')) {
                    e.preventDefault();
                }
            });
        }

        // Delete stocks/crypto form submission confirmation
        const deleteStocksForm = document.getElementById('delete-stocks-form');
        if (deleteStocksForm) {
            deleteStocksForm.addEventListener('submit', function (e) {
                if (!confirm('Are you sure you want to delete all stocks and crypto data for this account? This will remove all companies, shares, and market prices. This action cannot be undone.')) {
                    e.preventDefault();
                }
            });
        }

        // Reset settings confirmation
        const resetForm = document.getElementById('reset-account-form');
        if (resetForm) {
            resetForm.addEventListener('submit', function (e) {
                if (!confirm('Reset all saved settings for this account?')) {
                    e.preventDefault();
                }
            });
        }

        // Import data modal functions
        window.openImportModal = function() {
            const modal = new bootstrap.Modal(document.getElementById('import-modal'));
            modal.show();
        };

        window.confirmImport = function() {
            const fileInput = document.querySelector('input[name="import_file"]');
            if (!fileInput.files.length) {
                alert('Please select a file first');
                return;
            }

            if (confirm('Are you absolutely sure you want to overwrite ALL your account data? This action cannot be undone.')) {
                document.getElementById('import-form').submit();
            }
        };
    });
</script>
{% endblock %}
